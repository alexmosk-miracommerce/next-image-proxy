!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("isomorphic-unfetch"),require("stream"),require("lodash.merge"),require("user-agents")):"function"==typeof define&&define.amd?define(["exports","isomorphic-unfetch","stream","lodash.merge","user-agents"],r):r((e||self).nextImageProxy={},e.isomorphicUnfetch,e.stream,e.merge,e.userAgents)}(this,function(e,r,t,n,s){function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=o(r),a=o(t),u=o(n),f=o(s);function m(e,r){r.fallbackUrl.trim()?e.redirect(r.fallbackUrl):e.status(422).send({message:r.messages.imageFetchError})}e.withImageProxy=function(e){var r=u.default({whitelistedPatterns:[],fallbackUrl:"",messages:{wrongFormat:"Image url not provided or has wrong format",notWhitelisted:"Provided image url is not whitelisted",imageFetchError:"Couldn't fetch the image"}},e);return function(e,n){try{var s=new URL(e.query.imageUrl);Object.keys(e.query).map(function(r){return s.searchParams.append(r,e.query[r])});var o=s.href;if(!o||o&&Array.isArray(o))return n.status(400).send({message:r.messages.wrongFormat}),Promise.resolve();var u=function(e,r){return r.some(function(r){return e.match(r)})}(o,r.whitelistedPatterns);return u?Promise.resolve(function(e){try{return Promise.resolve(i.default(e,{headers:{"user-agent":(new f.default).toString()}}).then(function(e){return e.body}))}catch(e){return Promise.reject(e)}}(o)).then(function(e){e?function(e,r,n){var s=new t.Stream.PassThrough;a.default.pipeline(r,s,function(r){if(r)return console.log(r),void m(e,n)}),s.pipe(e)}(n,e,r):m(n,r)}):(n.status(422).send({message:r.messages.notWhitelisted}),Promise.resolve())}catch(e){return Promise.reject(e)}}}});
//# sourceMappingURL=next-image-proxy.umd.js.map
