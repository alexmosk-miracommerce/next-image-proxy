{"version":3,"file":"next-image-proxy.module.js","sources":["../src/index.ts"],"sourcesContent":["import { NextApiRequest, NextApiResponse } from 'next'\nimport fetch from 'isomorphic-unfetch'\nimport stream, { Stream } from 'stream'\nimport merge from 'lodash.merge'\nimport UserAgent from 'user-agents'\nimport { DeepPartial, Options } from './types'\n\nexport function withImageProxy(passedOptions?: DeepPartial<Options>) {\n  const defaultOptions: Options = {\n    whitelistedPatterns: [],\n    fallbackUrl: '',\n    messages: {\n      wrongFormat: 'Image url not provided or has wrong format',\n      notWhitelisted: 'Provided image url is not whitelisted',\n      imageFetchError: \"Couldn't fetch the image\",\n    },\n  }\n\n  const options: Options = merge(defaultOptions, passedOptions)\n\n  return async function (req: NextApiRequest, res: NextApiResponse) {\n    const url = new URL(req.query.imageUrl as string);\n\n    Object.keys(req.query).map((key) =>\n      url.searchParams.append(key, req.query[key] as string),\n    );\n\n    const imageUrl = url.href;\n\n    if (!imageUrl || (imageUrl && Array.isArray(imageUrl))) {\n      res.status(400).send({ message: options.messages.wrongFormat })\n      return\n    }\n\n    const isAllowed = isUrlWhitelisted(imageUrl, options.whitelistedPatterns)\n\n    if (!isAllowed) {\n      res.status(422).send({ message: options.messages.notWhitelisted })\n      return\n    }\n\n    const imageBlob = await fetchImageBlob(imageUrl)\n\n    if (!imageBlob) {\n      handleFallback(res, options)\n      return\n    }\n\n    pipeImage(res, imageBlob, options)\n  }\n}\n\nfunction pipeImage(res: NextApiResponse, imageBlob: ReadableStream<Uint8Array>, options: Options) {\n  const passThrough = new Stream.PassThrough()\n\n  stream.pipeline(imageBlob as unknown as NodeJS.ReadableStream, passThrough, (err) => {\n    if (err) {\n      console.log(err)\n      handleFallback(res, options)\n      return\n    }\n  })\n  passThrough.pipe(res)\n}\n\nfunction handleFallback(res: NextApiResponse, options: Options) {\n  if (options.fallbackUrl.trim()) {\n    res.redirect(options.fallbackUrl)\n  } else {\n    res.status(422).send({ message: options.messages.imageFetchError })\n  }\n}\n\nasync function fetchImageBlob(url: string) {\n  return await fetch(url, {\n    headers: { 'user-agent': new UserAgent().toString() },\n  }).then((data) => data.body)\n}\n\nfunction isUrlWhitelisted(url: string, whitelistedPatterns: Options['whitelistedPatterns']) {\n  return whitelistedPatterns.some((singleHost) => {\n    return url.match(singleHost)\n  })\n}\n"],"names":["withImageProxy","passedOptions","options","merge","whitelistedPatterns","fallbackUrl","messages","wrongFormat","notWhitelisted","imageFetchError","req","res","url","URL","query","imageUrl","Object","keys","map","key","searchParams","append","href","Array","isArray","status","send","message","isAllowed","some","singleHost","match","isUrlWhitelisted","fetch","headers","UserAgent","toString","then","data","body","fetchImageBlob","imageBlob","passThrough","Stream","PassThrough","stream","pipeline","err","console","log","handleFallback","pipe","pipeImage","trim","redirect"],"mappings":"qIAOgBA,EAAeC,GAC7B,IAUMC,EAAmBC,EAVO,CAC9BC,oBAAqB,GACrBC,YAAa,GACbC,SAAU,CACRC,YAAa,6CACbC,eAAgB,wCAChBC,gBAAiB,6BAI0BR,GAE/C,gBAAuBS,EAAqBC,OAC1C,IAAMC,EAAM,IAAIC,IAAIH,EAAII,MAAMC,UAE9BC,OAAOC,KAAKP,EAAII,OAAOI,IAAI,SAACC,UAC1BP,EAAIQ,aAAaC,OAAOF,EAAKT,EAAII,MAAMK,MAGzC,IAAMJ,EAAWH,EAAIU,KAErB,IAAKP,GAAaA,GAAYQ,MAAMC,QAAQT,GAE1C,OADAJ,EAAIc,OAAO,KAAKC,KAAK,CAAEC,QAASzB,EAAQI,SAASC,gCAInD,IAAMqB,EA6CV,SAA0BhB,EAAaR,GACrC,OAAOA,EAAoByB,KAAK,SAACC,GAC/B,OAAOlB,EAAImB,MAAMD,KA/CCE,CAAiBjB,EAAUb,EAAQE,qBAErD,OAAKwB,2BAqCqBhB,8BACfqB,EAAMrB,EAAK,CACtBsB,QAAS,CAAE,cAAc,IAAIC,GAAYC,cACxCC,KAAK,SAACC,UAASA,EAAKC,2CAnCGC,CAAezB,kBAAjC0B,GAEDA,EAST,SAAmB9B,EAAsB8B,EAAuCvC,GAC9E,IAAMwC,EAAc,IAAIC,EAAOC,YAE/BC,EAAOC,SAASL,EAA+CC,EAAa,SAACK,GAC3E,GAAIA,EAGF,OAFAC,QAAQC,IAAIF,QACZG,EAAevC,EAAKT,KAIxBwC,EAAYS,KAAKxC,GAdfyC,CAAUzC,EAAK8B,EAAWvC,GAJxBgD,EAAevC,EAAKT,MAPpBS,EAAIc,OAAO,KAAKC,KAAK,CAAEC,QAASzB,EAAQI,SAASE,oCAjBrD,oCA6CF,SAAS0C,EAAevC,EAAsBT,GACxCA,EAAQG,YAAYgD,OACtB1C,EAAI2C,SAASpD,EAAQG,aAErBM,EAAIc,OAAO,KAAKC,KAAK,CAAEC,QAASzB,EAAQI,SAASG"}